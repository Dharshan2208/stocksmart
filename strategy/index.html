<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trading Strategy Generator</title>
    <style>
      :root {
        --primary-color: #2a2f4f;
        --secondary-color: #917fb3;
        --accent-color: #4caf50;
        --background-color: #121212;
        --text-color: #e5e5e5;
        --chat-user-bg: #333344;
        --chat-bot-bg: #2a2f4f;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: var(--background-color);
        color: var(--text-color);
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: auto;
        margin: 0;
        padding: 0;
      }

      header {
        background-color: var(--primary-color);
        color: white;
        padding: 0.8rem;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      }

      .container {
        width: auto;
        max-width: 1000px;
        margin: 15px auto;
        padding: 0;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }

      .chat-container {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        border-radius: 12px;
        overflow: hidden;
        background-color: #1e1e1e;
      }

      .chat-header {
        background-color: var(--primary-color);
        padding: 1rem;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .chat-header h2 {
        margin: 0;
        font-weight: 600;
      }

      .chat-header .bot-status {
        height: 10px;
        width: 10px;
        background-color: var(--accent-color);
        border-radius: 50%;
      }

      .chat-messages {
        flex-grow: 1;
        padding: 1rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        max-height: calc(100vh - 220px);
        min-height: 400px;
        /* Hide scrollbar for Chrome, Safari and Opera */
        &::-webkit-scrollbar {
          display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        -ms-overflow-style: none; /* IE and Edge */
        scrollbar-width: none; /* Firefox */
      }

      .message {
        max-width: 85%;
        padding: 0.7rem 0.9rem;
        border-radius: 8px;
        line-height: 1.4;
        margin: 0;
      }

      .user-message {
        align-self: flex-end;
        background-color: var(--chat-user-bg);
        border-radius: 18px 18px 0 18px;
      }

      .bot-message {
        align-self: flex-start;
        background-color: var(--chat-bot-bg);
        border-radius: 18px 18px 18px 0;
      }

      .chat-input {
        display: flex;
        gap: 8px;
        padding: 0.75rem;
        background-color: #2a2a2a;
        border-top: 1px solid #333;
      }

      .chat-input input {
        flex-grow: 1;
        padding: 12px 16px;
        border: none;
        border-radius: 24px;
        background-color: #3a3a3a;
        color: var(--text-color);
        font-size: 1rem;
      }

      .chat-input input:focus {
        outline: none;
        box-shadow: 0 0 0 2px var(--secondary-color);
      }

      .chat-input button {
        background-color: var(--accent-color);
        color: white;
        border: none;
        border-radius: 24px;
        padding: 0 20px;
        cursor: pointer;
        font-weight: 600;
        transition: background-color 0.2s;
      }

      .chat-input button:hover {
        background-color: #3d8b3d;
      }

      .typing-indicator {
        display: flex;
        align-items: center;
        gap: 5px;
        margin-top: 2px;
        font-size: 0.9rem;
        color: #aaa;
        padding-left: 10px;
      }

      .typing-indicator span {
        height: 8px;
        width: 8px;
        background-color: #aaa;
        border-radius: 50%;
        display: inline-block;
        animation: typing 1.4s infinite ease-in-out both;
      }

      .typing-indicator span:nth-child(1) {
        animation-delay: 0s;
      }

      .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing {
        0%,
        100% {
          transform: scale(0.6);
          opacity: 0.6;
        }
        50% {
          transform: scale(1);
          opacity: 1;
        }
      }

      .strategy-card {
        background-color: #2c2c42;
        border-radius: 8px;
        padding: 0.75rem;
        margin-top: 0.4rem;
        margin-bottom: 0;
        border-left: 4px solid var(--accent-color);
      }

      .strategy-card h3 {
        color: var(--accent-color);
        margin-bottom: 0.4rem;
      }

      footer {
        text-align: center;
        padding: 0.8rem;
        margin: 10px 0 0 0;
        font-size: 0.9rem;
        color: #888;
      }

      /* Loading spinner */
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: var(--accent-color);
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Responsive design */
      @media (max-width: 768px) {
        .container {
          padding: 0;
        }

        .message {
          max-width: 90%;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>AI Trading Strategy Generator</h1>
    </header>

    <div class="container">
      <div class="chat-container">
        <div class="chat-header">
          <div class="bot-status"></div>
          <h2>Strategy Assistant</h2>
        </div>

        <div class="chat-messages" id="chatMessages">
          <div class="message bot-message">
            Hello! I'm your AI trading strategy assistant. Tell me about your
            investment goals, risk tolerance, and preferred assets, and I'll
            help generate a personalized trading strategy for you.
          </div>
        </div>

        <div class="chat-input">
          <input
            type="text"
            id="userInput"
            placeholder="Ask about trading strategies..."
            autocomplete="off"
          />
          <button id="sendButton">Send</button>
        </div>
      </div>
    </div>

    <footer>
      &copy; 2023 Trading Strategy Generator | Powered by Gemini AI
    </footer>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const chatMessages = document.getElementById("chatMessages");
        const userInput = document.getElementById("userInput");
        const sendButton = document.getElementById("sendButton");

        // API URL
        const API_URL = "/api/gemini";

        // Track API failures to fall back to demo mode
        let apiFailureCount = 0;
        const MAX_API_FAILURES = 2;
        let useDemoMode = false;

        // Sample predefined responses for demo mode fallback
        const demoResponses = [
          {
            keywords: ["stock", "stocks", "equity"],
            response: `Based on your interest in stocks, here's a recommended strategy:

            <div class="strategy-card">
              <h3>Diversified Growth Strategy</h3>
              <p><strong>Allocation:</strong> 60% large-cap, 30% mid-cap, 10% small-cap stocks</p>
              <p><strong>Time Horizon:</strong> Medium to long-term (3-5+ years)</p>
              <p><strong>Risk Level:</strong> Moderate</p>
              <p><strong>Approach:</strong> Focus on quality companies with strong fundamentals and growth potential. Consider dollar-cost averaging to reduce timing risk.</p>
            </div>`,
          },
          {
            keywords: ["crypto", "bitcoin", "ethereum"],
            response: `Based on your interest in crypto, here's a recommended strategy:

            <div class="strategy-card">
              <h3>Crypto Core-Satellite Strategy</h3>
              <p><strong>Allocation:</strong> 60% Bitcoin/Ethereum, 40% alt-coins</p>
              <p><strong>Time Horizon:</strong> Variable (1-5 years)</p>
              <p><strong>Risk Level:</strong> High</p>
              <p><strong>Approach:</strong> Hold core positions in established cryptocurrencies while taking calculated positions in promising alt-coins. Set strict stop-loss levels and consider DCA during major market corrections.</p>
            </div>`,
          },
          {
            keywords: ["forex", "currency", "trading"],
            response: `Based on your interest in forex trading, here's a recommended strategy:

            <div class="strategy-card">
              <h3>Trend-Following Forex Strategy</h3>
              <p><strong>Pairs Focus:</strong> Major pairs (EUR/USD, GBP/USD, USD/JPY)</p>
              <p><strong>Time Horizon:</strong> Short to medium-term</p>
              <p><strong>Risk Level:</strong> Moderate to High</p>
              <p><strong>Approach:</strong> Utilize moving average crossovers and momentum indicators to identify trending markets. Implement proper position sizing (1-2% risk per trade) and maintain consistent risk-reward ratios of at least 1:2.</p>
            </div>`,
          },
          {
            keywords: ["etf", "index", "passive"],
            response: `Based on your interest in passive investing, here's a recommended strategy:

            <div class="strategy-card">
              <h3>Global ETF Portfolio</h3>
              <p><strong>Allocation:</strong> 60% broad market ETFs, 20% sector-specific ETFs, 20% bond ETFs</p>
              <p><strong>Time Horizon:</strong> Long-term (5+ years)</p>
              <p><strong>Risk Level:</strong> Low to Moderate</p>
              <p><strong>Approach:</strong> Build a core portfolio with low-cost broad market ETFs. Add satellite positions in sector ETFs that align with long-term economic trends. Rebalance annually to maintain target allocation.</p>
            </div>`,
          },
        ];

        // Function to get a demo response
        function getDemoResponse(userMessage) {
          // Look for matching keywords
          for (const item of demoResponses) {
            if (
              item.keywords.some((keyword) =>
                userMessage.toLowerCase().includes(keyword.toLowerCase())
              )
            ) {
              return item.response;
            }
          }

          // Default response if no keywords matched
          return `To generate a trading strategy, I need more specific information. Could you tell me:
          <br><br>
          1. What assets are you interested in? (stocks, crypto, forex, etc.)<br>
          2. What's your risk tolerance? (low, moderate, high)<br>
          3. What's your investment timeframe?`;
        }

        // Function to add a message to the chat
        function addMessage(message, isUser = false) {
          const messageElement = document.createElement("div");
          messageElement.classList.add("message");
          messageElement.classList.add(isUser ? "user-message" : "bot-message");
          messageElement.innerHTML = message;
          chatMessages.appendChild(messageElement);
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Function to show typing indicator
        function showTypingIndicator() {
          const indicator = document.createElement("div");
          indicator.classList.add("typing-indicator");
          indicator.innerHTML = `
                    <span></span>
                    <span></span>
                    <span></span>
                `;
          indicator.id = "typingIndicator";
          chatMessages.appendChild(indicator);
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Function to remove typing indicator
        function removeTypingIndicator() {
          const indicator = document.getElementById("typingIndicator");
          if (indicator) {
            indicator.remove();
          }
        }

        // Function to call the Gemini API
        async function callGeminiAPI(userMessage) {
          // If in demo mode, return a predefined response
          if (useDemoMode) {
            return new Promise((resolve) => {
              setTimeout(() => {
                resolve(getDemoResponse(userMessage));
              }, 1000);
            });
          }

          try {
            // Add timeout to prevent indefinite waiting
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000);

            const response = await fetch(API_URL, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                message: userMessage,
              }),
              signal: controller.signal,
            });

            clearTimeout(timeoutId);

            const data = await response.json();

            if (!response.ok) {
              // Track API failures
              apiFailureCount++;
              if (apiFailureCount >= MAX_API_FAILURES) {
                console.log(
                  "Switching to demo mode after repeated API failures"
                );
                useDemoMode = true;
                return (
                  "API connection issues detected. Switching to demo mode for example strategies.<br><br>" +
                  getDemoResponse(userMessage)
                );
              }

              return (
                data.response ||
                "Sorry, I encountered an error generating your strategy. Please try again."
              );
            }

            // Reset failure count on success
            apiFailureCount = 0;
            return data.response;
          } catch (error) {
            console.error("Error calling Gemini API:", error);

            // Track API failures
            apiFailureCount++;
            if (apiFailureCount >= MAX_API_FAILURES) {
              console.log("Switching to demo mode after repeated API failures");
              useDemoMode = true;
              return (
                "API connection issues detected. Switching to demo mode for example strategies.<br><br>" +
                getDemoResponse(userMessage)
              );
            }

            if (error.name === "AbortError") {
              return "Request timed out. The server might be busy or unavailable. Please try again later.";
            }
            return "Sorry, I encountered an error generating your strategy. Please try again.";
          }
        }

        // Function to process user input and generate a response
        async function processUserInput() {
          const userMessage = userInput.value.trim();
          if (!userMessage) return;

          // Add user message to chat
          addMessage(userMessage, true);

          // Clear input field
          userInput.value = "";

          // Show typing indicator
          showTypingIndicator();

          try {
            // Use the Gemini API to get a response
            const botResponse = await callGeminiAPI(userMessage);

            // Remove typing indicator
            removeTypingIndicator();

            // Add bot response to chat
            addMessage(botResponse);
          } catch (error) {
            // Remove typing indicator
            removeTypingIndicator();

            // Add error message
            addMessage("Sorry, I encountered an error. Please try again.");
            console.error("Error processing message:", error);
          }
        }

        // Event listeners
        sendButton.addEventListener("click", processUserInput);

        userInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            processUserInput();
          }
        });

        // Focus input on load
        userInput.focus();
      });
    </script>
  </body>
</html>
